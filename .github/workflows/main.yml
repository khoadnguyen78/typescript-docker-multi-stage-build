name: CI + Scan + Build Docker Image

on:
  pull_request:
  push:
    branches:
      - master
    tags:
      - "v*"

jobs:
  # --------------------------------
  # 1. Build & Test (CI)
  # --------------------------------
  Build-and-test-npm-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test
        run: npm test

  # --------------------------------
  # 2. Code Scan (SAST)
  # --------------------------------
  CodeQL-scan:
    needs: [Build-and-test-npm-package]
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Analyze
        uses: github/codeql-action/analyze@v4

  # --------------------------------
  # 3. Build & Push Docker Image
  # --------------------------------
  Build-and-push-Docker-image:
    needs: [CodeQL-scan]
    runs-on: ubuntu-latest
    # only build images when merged on master or tags
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}:latest

  # --------------------------------
  # 4. Image Scan (Container Scan)
  # --------------------------------
  Trivy-image-scan:
    needs: [Build-and-push-Docker-image]
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  # --------------------------------
  # 5. Deploy to OKE
  # --------------------------------
  Deploy-to-OKE-dev:
    needs: [Trivy-image-scan]
    runs-on: ubuntu-latest

    environment: dev   # enables manual approval if configured

    permissions:
      contents: read

    steps:
      # -----------------------------
      # Checkout Helm chart
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v5

      # -----------------------------
      # Setup OCI CLI
      # -----------------------------
      - name: Install OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh
          bash install.sh --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          
      - name: Verify OCI CLI
        run: oci --version

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.oci/ssh_key.pem
          chmod 600 ~/.oci/ssh_key.pem

          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          EOF

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare Bastion SSH keys
        run: |
          echo "${{ secrets.BASTION_SSH_PRIVATE_KEY }}" > ~/.oci/bastion.key
          echo "${{ secrets.BASTION_SSH_PUBLIC_KEY }}" > ~/.oci/bastion.key.pub
          chmod 600 ~/.oci/bastion.key

      # - name: Create Bastion port-forwarding session
      #   id: bastion
      #   run: |
      #     SESSION_JSON=$(oci bastion session create-port-forwarding \
      #       --bastion-id "${{ secrets.BASTION_OCID }}" \
      #       --display-name bastion-session-2 \
      #       --ssh-public-key-file ~/.oci/bastion.key.pub \
      #       --target-private-ip "${{ secrets.OKE_API_PRIVATE_IP }}" \
      #       --target-port 6443 \
      #       --session-ttl 10800)

      #     echo "$SESSION_JSON"

      - name: Prepare SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_PRIVATE_KEY }}" > ~/.ssh/bastion.key
          chmod 600 ~/.ssh/bastion.key

      - name: Trust Bastion host
        run: |
          ssh-keyscan -H "host.bastion.ap-singapore-1.oci.oraclecloud.com" >> ~/.ssh/known_hosts
      
      - name: Open SSH tunnel via Bastion
        run: |
          ssh -i ~/.ssh/bastion.key -N -L 6443:10.0.0.2:6443 -p 22 ocid1.bastionsession.oc1.ap-singapore-1.amaaaaaas66yipia4gkhmmhze5j5rmw5z323tlhojgfuhsbg55epv2b7ad2q@host.bastion.ap-singapore-1.oci.oraclecloud.com &
          echo "SSH tunnel started"
          sleep 10

      # -----------------------------
      # Get kubeconfig from OKE
      # -----------------------------
      - name: Prepare kube directory
        run: mkdir -p $HOME/.kube

      - name: Get kubeconfig (private)
        run: |
          oci ce cluster create-kubeconfig \
            --cluster-id "${{ secrets.OKE_CLUSTER_OCID }}" \
            --file "$HOME/.kube/config" \
            --region "${{ secrets.OCI_REGION }}" \
            --token-version 2.0.0 \
            --endpoint PRIVATE_ENDPOINT

      - name: Patch kubeconfig to localhost
        run: |
          sed -i 's#https://.*:6443#https://127.0.0.1:6443#g' $HOME/.kube/config

      # -----------------------------
      # Verify cluster access
      # -----------------------------
      - name: Verify cluster
        run: |
          kubectl get nodes

      # -----------------------------
      # Deploy using Helm
      # -----------------------------
      - name: Deploy with Helm
        run: |
          helm upgrade --install my-platform ./helm \
            --namespace app \
            --create-namespace \
            --set apps.app1.image.repository=ghcr.io/${{ github.repository }} \
            --set apps.app1.image.tag=${{ github.sha }}
